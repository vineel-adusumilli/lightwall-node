<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>LightWall</title>

    <style type="text/css">
      #main {
        width: 256px;
        margin-left: auto;
        margin-right: auto;
      }

      #color, #fire, #blueglow {
        display: block;
        width: 256px;
      }

      #color {
        height: 50px;
      }
    </style>

    <script type="text/javascript" src="http://zeptojs.com/zepto.min.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script>
      function getPos(canvas, x, y) {
        var obj = canvas;
        var top = 0;
        var left = 0;
        while (obj.tagName != 'BODY') {
          top += obj.offsetTop;
          left += obj.offsetLeft;
          obj = obj.offsetParent;
        }

        return {
          x: x - left + window.pageXOffset,
          y: y - top + window.pageYOffset
        };
      }

      $(document).ready(function() {
        var aWantsUntrusted = false;

        var socket = io.connect('http://' + window.location.hostname);
        socket.on('update rgb', function(data) {
          $('#color').css('background-color', 'rgb(' + data.r + ',' + data.g + ',' + data.b + ')');
        });

        var canvas = $('#canvas')[0];
        var ctx = canvas.getContext('2d');
        var padding = 0;
        var image = new Image();
        image.onload = function() {
          ctx.drawImage(image, padding, padding);
        }
        image.src = 'color_picker.png';

        var mouseDown = false;

        $('#canvas').bind('mousedown', function(evt) {
          mouseDown = true;
          getColor(evt.clientX, evt.clientY);
        }, aWantsUntrusted);

        $('#canvas').bind('mouseup', function() {
          mouseDown = false;
        }, aWantsUntrusted);

        $('#canvas').bind('mouseout', function() {
          mouseDown = false;
        }, aWantsUntrusted);

        $('#canvas').bind('mousemove', function(evt) {
          if (mouseDown)
            getColor(evt.clientX, evt.clientY);
        }, aWantsUntrusted);

        $('#canvas').bind('touchstart', updateTouch, aWantsUntrusted);
        $('#canvas').bind('touchmove', updateTouch, aWantsUntrusted);

        function updateTouch(evt) {
          evt.preventDefault();
          evt.stopPropagation();
          if (evt.targetTouches.length == 1) {
            var touch = event.targetTouches[0];
            getColor(touch.pageX, touch.pageY);
          }
        }

        $('#fire').click(function() {
          socket.emit('fire');
        });

        $('#blueglow').click(function() {
          socket.emit('blue glow');
        });

        function getColor(x, y) {
          var pos = getPos(canvas, x, y);
          if (pos !== null &&
              pos.x > padding &&
              pos.x < padding + image.width &&
              pos.y > padding &&
              pos.y < padding + image.height) {
            var imageData = ctx.getImageData(padding, padding, image.width, image.height);
            var data = imageData.data;
            var relX = pos.x - padding;
            var relY = pos.y - padding;
            var red = data[((image.width * relY) + relX) * 4];
            var green = data[((image.width * relY) + relX) * 4 + 1];
            var blue = data[((image.width * relY) + relX) * 4 + 2];
            socket.emit('rgb', { r: red, g: green, b: blue });
          }
        }
      });
    </script>
  </head>
  <body>
    <div id="main">
      <canvas id="canvas" width="256" height="256"></canvas>
      <input type="button" id="fire" value="Fire" />
      <input type="button" id="blueglow" value="Blue Glow" />
      <div id="color"></div>
    </div>
  </body>
</html>
